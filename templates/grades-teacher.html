{% extends 'base.html' %}
{% load static %}
{% block page_title %}成绩管理（教师）{% endblock %}
{% block page_header %}成绩管理（教师）{% endblock %}
{% block head %}
<link rel="stylesheet" href="{% static 'css/management/grades.css' %}">
{% endblock %}

{% block content %}
<div class="grades-management-container">
    <!-- 区域1：我授课的班级列表 -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="card-title mb-0">
                    <i class="fas fa-users me-2"></i>我授课的班级
                </h5>
                <div class="d-flex align-items-center gap-2">
                    <button class="btn btn-sm btn-outline-primary" onclick="refreshTeacherClasses()" title="刷新班级列表和及格率">
                        <i class="fas fa-sync-alt me-1"></i>刷新
                    </button>
                    <small class="text-muted" id="teacherClassHint">
                        仅显示当前教师所授课程对应的班级（按课程+班级组合）
                    </small>
                </div>
            </div>

            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 200px;">课程名称</th>
                            <th>班级名称</th>
                            <th style="width: 120px;">班级人数</th>
                            <th style="width: 140px;">平均分</th>
                            <th style="width: 140px;">及格率</th>
                            <th style="width: 120px;" class="text-center">操作</th>
                        </tr>
                    </thead>
                    <tbody id="teacherClassTableBody">
                        <tr>
                            <td colspan="7" class="text-center text-muted py-5">
                                <i class="fas fa-spinner fa-spin fa-3x mb-3"></i>
                                <p>正在加载您授课的班级...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 区域2：当前班级学生成绩列表 -->
    <div class="card shadow-sm">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <h5 class="card-title mb-2">
                        <i class="fas fa-list me-2"></i>学生成绩列表
                    </h5>
                    <div class="d-flex align-items-center gap-3 flex-wrap">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-book text-primary me-2"></i>
                            <span class="text-muted small">课程：</span>
                            <span class="fw-semibold ms-1" id="currentCourseName">-</span>
                        </div>
                        <div class="d-flex align-items-center">
                            <i class="fas fa-users text-info me-2"></i>
                            <span class="text-muted small">班级：</span>
                            <span class="fw-semibold ms-1" id="currentClassName">-</span>
                        </div>
                        <div class="d-flex align-items-center">
                            <i class="fas fa-user-graduate text-success me-2"></i>
                            <span class="text-muted small">人数：</span>
                            <span class="fw-semibold ms-1" id="currentClassStudentCount">0</span>
                        </div>
                    </div>
                </div>
                <div class="d-flex gap-2 flex-wrap">
                    <button class="btn btn-outline-secondary btn-sm" id="btnExportTemplate" disabled onclick="exportClassGradesTemplate()">
                        <i class="fas fa-file-export me-1"></i>导出成绩表
                    </button>
                    <label class="btn btn-outline-primary btn-sm mb-0">
                        <i class="fas fa-file-import me-1"></i>导入成绩表
                        <input type="file" id="importFileInput" accept=".xlsx,.xls" style="display: none;" onchange="handleImportFileChange(event)">
                    </label>
                    <button class="btn btn-success btn-sm" id="btnSaveAll" disabled onclick="saveAllGradesForCurrentClass()">
                        <i class="fas fa-save me-1"></i>保存当前班级成绩
                    </button>
                </div>
            </div>

            <div class="alert alert-info py-2 mb-3">
                <small>
                    总分 = 平时分 × 60% + 期末分 × 40%，总分自动计算且禁止手动修改；总分 ≥ 60 记为“及格”。
                </small>
            </div>

            <div class="table-responsive">
                <table class="table table-bordered align-middle">
                    <thead class="table-dark">
                        <tr>
                            <th style="width: 80px;">序号</th>
                            <th style="width: 140px;">学号</th>
                            <th style="width: 120px;">姓名</th>
                            <th style="width: 140px;">平时分 (60%)</th>
                            <th style="width: 140px;">期末分 (40%)</th>
                            <th style="width: 140px;">总分</th>
                            <th style="width: 120px;">状态</th>
                        </tr>
                    </thead>
                    <tbody id="teacherStudentTableBody">
                        <tr>
                            <td colspan="8" class="text-center text-muted py-5">
                                <i class="fas fa-info-circle fa-3x mb-3"></i>
                                <p>请选择上方列表中的一个班级查看学生成绩</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- 导入处理中遮罩 -->
<div id="teacherGradesLoadingOverlay" style="display: none;">
    <div class="loading-spinner">
        <i class="fas fa-spinner fa-spin fa-3x"></i>
        <p class="mt-3">处理中，请稍候...</p>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="{% static 'js/grades/grades-teacher.js' %}"></script>
{% endblock %}

