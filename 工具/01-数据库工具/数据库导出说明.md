# 数据库导出工具使用说明

## 功能说明

此工具用于将Django项目的MySQL数据库完整备份，包括：
1. **创建数据库**的SQL语句
2. **创建表结构**的SQL语句（CREATE TABLE）
3. **所有数据**的INSERT语句
4. **多对多关系表**的数据

生成的SQL文件可以直接用于在新环境中重建完整的数据库。

## 使用方法

### 方法一：使用批处理文件（推荐）

1. 双击运行 `工具/01-数据库工具/export_database.bat` 文件
2. 等待导出完成
3. 生成的SQL文件将保存在项目根目录，文件名为 `database_export.sql`

### 方法二：使用Python命令

**完整备份（推荐）**：
```bash
python 工具/01-数据库工具/export_database_to_mysql.py
```

**指定输出文件名**：
```bash
python 工具/01-数据库工具/export_database_to_mysql.py my_backup.sql
```

**只导出数据（不包含创建数据库和表结构）**：
```bash
python 工具/01-数据库工具/export_database_to_mysql.py --data-only
```

**不包含表结构（只包含创建数据库和数据）**：
```bash
python 工具/01-数据库工具/export_database_to_mysql.py --no-structure
```

## 导出内容

脚本会自动导出以下内容：

1. **创建数据库语句**
   - CREATE DATABASE IF NOT EXISTS
   - USE database_name

2. **表结构定义**
   - 所有表的CREATE TABLE语句
   - 包含字段定义、索引、外键约束等

3. **所有Django应用的数据表**
   - django.contrib.auth（用户认证）
   - django.contrib.contenttypes（内容类型）
   - django.contrib.sessions（会话）
   - django.contrib.admin（管理后台）
   - accounts（账户）
   - organization（组织架构）
   - personnel（人员管理）
   - courses（课程）
   - attendance_app（考勤）
   - grades（成绩）
   - notices（通知）
   - calendarapp（日历）
   - classrooms（教室）
   - students（学生）
   - exams（考试）
   - teachers（教师）
   - system（系统）

2. **多对多关系表**
   - 自动检测并导出所有多对多关系中间表

## 导出文件格式

生成的SQL文件按以下顺序组织：

1. **文件头信息**
   - 生成时间、数据库名、Django版本等

2. **创建数据库**
   - CREATE DATABASE语句
   - USE语句

3. **表结构定义**
   - 所有表的CREATE TABLE语句

4. **数据导入部分**
   - 事务控制语句（SET FOREIGN_KEY_CHECKS=0等）
   - 按应用分组的INSERT语句
   - 多对多关系表数据
   - COMMIT语句

## 导入数据

### 方法一：使用命令行（推荐）

```bash
mysql -u root -p < database_export.sql
```

这会自动：
- 创建数据库（如果不存在）
- 创建所有表结构
- 导入所有数据

### 方法二：在MySQL客户端中

```sql
source database_export.sql;
```

或者直接复制SQL文件内容到MySQL客户端执行。

### 方法三：只导入数据（如果数据库和表已存在）

如果使用 `--data-only` 选项导出的文件，可以直接导入到已存在的数据库中：

```bash
mysql -u root -p existing_database < database_export.sql
```

## 注意事项

1. **数据库连接**：确保数据库配置正确（在 `EduCloud/settings.py` 中）
2. **权限**：确保有读取数据库的权限
3. **文件大小**：如果数据量很大，生成的SQL文件可能会很大
4. **字符编码**：文件使用UTF-8编码，确保MySQL数据库也使用UTF-8编码
5. **外键约束**：导出时会临时禁用外键检查，导入时会自动恢复

## 文件说明

- `export_database_to_mysql.py` - 主导出脚本
- `export_database.bat` - Windows批处理文件，方便快速运行
- `database_export.sql` - 导出的SQL文件（运行后生成）

## 技术特点

- ✅ **一键完整备份**：包括创建数据库、表结构和所有数据
- ✅ **自动检测所有Django模型**：无需手动配置
- ✅ **批量处理**：避免内存溢出，支持大数据量
- ✅ **正确处理外键关系**：自动处理外键约束
- ✅ **支持多对多关系表**：自动检测并导出中间表
- ✅ **完善的错误处理**：导出失败不影响其他表
- ✅ **详细的导出日志**：显示每个表的导出状态
- ✅ **灵活的导出选项**：支持只导出数据或完整备份

## 常见问题

**Q: 导出失败怎么办？**
A: 检查数据库连接配置，确保数据库服务正在运行，并且有足够的权限。

**Q: 可以只导出特定应用的数据吗？**
A: 可以修改脚本中的 `installed_apps` 列表，只包含需要导出的应用。

**Q: 导出的SQL文件很大怎么办？**
A: 可以使用压缩工具压缩SQL文件，或者分批导出不同应用的数据。

**Q: 如何在新服务器上恢复数据库？**
A: 直接执行导出的SQL文件即可，脚本会自动创建数据库、表结构和导入数据：
```bash
mysql -u root -p < database_export.sql
```

**Q: 只想要数据，不想要表结构怎么办？**
A: 使用 `--data-only` 参数：
```bash
python 工具/01-数据库工具/export_database_to_mysql.py --data-only
```
