# 考勤管理系统更新说明

## 更新概述

根据需求，已完成考勤管理系统的全面升级，实现了按课程管理的考勤功能，支持自动生成默认考勤记录，并完善了教师和学生的权限管理。

## 主要更新内容

### 1. 数据模型更新 (`attendance_app/models.py`)

#### 修改内容：
- **唯一约束调整**：从 `(student, date)` 改为 `(student, schedule, date)`，支持按课程管理考勤
- **schedule字段**：从可选改为必填，从 `SET_NULL` 改为 `CASCADE`
- **status字段**：添加默认值 `'present'`（正常）
- **添加索引**：优化查询性能
- **添加中文名称**：所有字段添加 `verbose_name`

#### 影响：
- 考勤记录现在必须关联到具体的课程安排
- 一个学生可以在同一天有多条考勤记录（不同课程）
- 支持按课程维度进行考勤管理

### 2. 数据库迁移 (`attendance_app/migrations/0003_update_attendance_model.py`)

#### 迁移步骤：
1. 清理现有没有schedule关联的考勤记录
2. 修改schedule字段为必填
3. 添加status默认值
4. 更新唯一约束
5. 添加性能索引

#### 注意事项：
- **重要**：迁移会删除所有没有schedule关联的旧考勤记录
- 建议在生产环境执行前先备份数据

### 3. 序列化器增强 (`attendance_app/serializers.py`)

#### 新增字段：
- `student_id`: 学号
- `student_name`: 学生姓名
- `course_name`: 课程名称
- `course_id`: 课程ID
- `schedule_id`: 课程安排ID
- `class_name`: 班级名称
- `college_name`: 学院名称
- `major_name`: 专业名称
- `status_display`: 状态中文显示

#### 优势：
- 前端可以直接显示完整信息，无需额外API调用
- 减少前端数据处理的复杂度

### 4. 视图逻辑完善 (`attendance_app/views.py`)

#### 核心功能：

##### 自动生成默认考勤记录
- **实现方式**：在教师查询某课程的考勤时，自动为课程中所有学生生成"正常"状态的考勤记录
- **触发条件**：GET请求 + 指定schedule和date参数
- **逻辑**：检查该课程当天是否已有记录，为没有记录的学生自动创建

##### 权限控制
- **教师权限**：
  - 只能查看和管理自己教授的课程的考勤
  - 创建/更新考勤记录时验证课程是否属于该教师
- **学生权限**：
  - 只能查看自己的考勤记录
  - 可以查看当天所有课程的考勤状态
- **管理员权限**：
  - 可以查看和管理所有考勤记录

##### 筛选功能
- 支持按课程（schedule）筛选
- 支持按日期筛选
- 支持按学院、专业、班级、学生筛选
- 支持关键词搜索（学号、姓名、课程名等）

### 5. 前端界面更新

#### HTML模板 (`templates/attendance.html`)
- 添加课程筛选下拉框
- 添加备注列
- 优化表格布局，显示课程信息

#### JavaScript逻辑 (`static/js/attendance/attendance.js`)

##### 主要功能：
1. **课程筛选**：
   - 教师可以看到自己教授的所有课程
   - 选择课程后显示该课程的学生考勤

2. **自动生成记录**：
   - 选择课程和日期后，自动为所有学生生成默认"正常"记录
   - 教师只需修改异常学生的状态

3. **备注编辑**：
   - 教师可以直接在表格中编辑备注
   - 支持实时保存

4. **学生视图**：
   - 学生登录后自动显示当天所有课程的考勤状态
   - 不显示课程筛选（因为显示所有课程）

5. **批量操作**：
   - "本日全部正常"按钮：将选定课程的所有学生标记为正常

## 使用说明

### 教师使用流程

1. **选择课程和日期**
   - 在"选择课程"下拉框中选择要管理的课程
   - 选择考勤日期（默认为今天）

2. **查看考勤记录**
   - 系统自动为该课程的所有学生生成"正常"状态的考勤记录
   - 表格显示所有学生的考勤信息

3. **修改考勤状态**
   - 在"考勤状态"列的下拉框中选择新的状态（正常/迟到/缺勤/请假）
   - 系统自动保存

4. **填写备注**
   - 在"备注"列输入框中填写备注原因
   - 失去焦点时自动保存

5. **批量操作**
   - 点击"本日全部正常"按钮，可将所有学生标记为正常

### 学生使用流程

1. **查看考勤**
   - 登录后进入考勤管理页面
   - 自动显示当天所有课程的考勤状态
   - 可以查看每门课程的考勤状态和备注

### 筛选功能

- **按课程筛选**：选择特定课程查看考勤
- **按学院/专业/班级筛选**：缩小查看范围
- **按学生筛选**：查看特定学生的考勤
- **关键词搜索**：支持搜索学号、姓名、课程名等

## 技术细节

### 自动生成逻辑

```python
def _ensure_default_attendance(self, schedule, attendance_date):
    """确保课程中所有学生都有默认的考勤记录"""
    students = StudentProfile.objects.filter(school_class=schedule.school_class)
    existing_attendance = Attendance.objects.filter(
        schedule=schedule,
        date=attendance_date
    ).values_list('student_id', flat=True)
    
    students_to_create = students.exclude(id__in=existing_attendance)
    # 批量创建默认记录
```

### 权限验证

```python
# 教师只能管理自己教授的课程
allowed_schedules = CourseSchedule.objects.filter(teacher=teacher)
qs = Attendance.objects.filter(schedule__in=allowed_schedules)
```

## 数据库变更

### 表结构变更

**attendance_app_attendance 表**：
- `schedule_id`: 从可空改为必填
- `status`: 添加默认值 `'present'`
- 唯一约束：`(student_id, schedule_id, date)`（原为 `(student_id, date)`）

### 索引优化

- `attendance_app_date_status_idx`: 按日期和状态查询
- `attendance_app_schedule_date_idx`: 按课程和日期查询

## 注意事项

1. **数据迁移**：
   - 执行迁移前请备份数据库
   - 迁移会删除没有schedule关联的旧记录

2. **性能考虑**：
   - 自动生成记录使用批量创建，性能优化
   - 添加了必要的数据库索引

3. **权限安全**：
   - 所有操作都经过权限验证
   - 教师只能管理自己教授的课程

4. **数据完整性**：
   - 通过唯一约束保证数据不重复
   - 通过外键约束保证数据关联正确

## 后续优化建议

1. **考勤统计**：
   - 可以添加考勤统计功能（出勤率、缺勤次数等）

2. **批量导入**：
   - 支持Excel批量导入考勤记录

3. **考勤提醒**：
   - 可以添加考勤提醒功能（提醒教师及时录入）

4. **历史记录**：
   - 可以添加考勤历史记录查看功能

## 更新日期

2025-01-XX

## 开发者

Auto (AI Assistant)

