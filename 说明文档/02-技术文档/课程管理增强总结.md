# 课程管理系统增强功能实现总结

## 概述
本次更新全面增强了课程管理系统，实现了课程搜索优化、课程编辑、智能排课（20周）、冲突检测和自动优化等核心功能。

## 功能实现清单

### 一、课程搜索与显示优化

#### 1. 课程名称显示格式
- **实现**：课程列表显示格式更新为"课程名称—老师"
- **位置**：
  - 前端：`static/js/courses/courses.js` - `loadCourses()` 函数
  - 拖拽卡片：`renderPalette()` 函数
- **效果**：用户可以一目了然地看到课程及其授课教师

#### 2. 实时搜索与筛选
- **已有功能**：支持实时搜索课程名称、教师姓名
- **筛选功能**：支持按学院-专业筛选课程
- **位置**：`static/js/courses/courses.js` - `loadCourses()` 函数

### 二、课程编辑功能

#### 1. 编辑入口
- **实现**：每个课程旁添加编辑按钮
- **触发**：点击课程后弹出编辑表单
- **位置**：`static/js/courses/courses.js` - `editCourse()` 函数

#### 2. 可编辑字段
- 课程名称
- 课程类型（必修/选修）
- 课程教师（支持搜索和筛选）

#### 3. 教师选择功能
- **实时搜索**：输入教师姓名或工号进行搜索
- **学院-专业筛选**：级联选择，先选学院再选专业
- **位置**：
  - 前端：`loadEditTeacherOptions()`、`loadEditTeacherColleges()`、`loadEditTeacherCollegeDepts()`
  - 模态框：`templates/courses.html` - `editCourseModal`

### 三、新增课程功能

#### 1. 必填字段调整
- **必填**：课程名称、必修/选修、课程教师
- **可选**：学院-专业（支持跨学院专业班级排课）

#### 2. 跨学院排课支持
- **后端修改**：
  - `courses/models.py`：`department` 字段添加 `blank=True`
  - `courses/serializers.py`：移除专业必填验证
- **说明**：所有课程默认可以跨学院、专业、班级进行排课

### 四、智能排课功能

#### 1. 排课范围
- **周期**：第1周至第20周
- **工作日**：周一至周五
- **时间段**：根据系统配置的时间段（上午4节+下午4节）

#### 2. 智能算法
- **优先级策略**：
  - 必修课优先安排在上午
  - 优先安排在早期时间段
  - 均匀分布在周一到周五（周三权重最高）
- **冲突避免**：
  - 检测班级时间冲突
  - 检测教师时间冲突
  - 检测教室时间冲突

#### 3. 实现位置
- **后端**：`courses/views.py` - `AutoScheduleView`
- **前端**：`static/js/courses/courses.js` - `autoSchedule()` 函数
- **API端点**：`POST /api/courses/schedules/auto`

### 五、冲突检测功能

#### 1. 检测范围
- 检测所有周的课程安排冲突
- 支持班级、教师、教室视角的冲突检测

#### 2. 冲突类型
- **教师冲突**：同一教师在同一时间段有多个课程
- **班级冲突**：同一班级在同一时间段有多个课程
- **教室冲突**：同一教室在同一时间段被多次使用

#### 3. 检测结果展示
- **无冲突**：弹出成功提示模态框
- **有冲突**：
  - 显示冲突数量
  - 列出每个冲突的详细信息（时间、周次、冲突类型）
  - 课表中标红显示冲突课程
  - 提供自动优化按钮

#### 4. 实现位置
- **后端**：`courses/views.py` - `CourseScheduleViewSet.conflicts()`
- **前端**：
  - `static/js/courses/courses.js` - `checkConflicts()`、`showConflictModal()`
  - `templates/courses.html` - `conflictModal`
- **API端点**：`GET /api/courses/schedules/conflicts/`

### 六、自动优化功能

#### 1. 优化策略
- 保留第一个冲突课程在原时间段
- 将其他冲突课程移动到可用时间段
- 确保移动后不产生新的冲突（教师、班级、教室）

#### 2. 优化结果
- **全部成功**：弹出优化成功提示
- **部分成功**：显示成功和失败数量
- **失败原因**：无可用时间段

#### 3. 实现位置
- **后端**：`courses/views.py` - `OptimizeConflictsView`
- **前端**：`static/js/courses/courses.js` - `optimizeConflicts()` 函数
- **API端点**：`POST /api/courses/schedules/optimize-conflicts`

## 文件修改清单

### 后端文件

#### 1. `courses/models.py`
```python
# 修改：使专业字段可选
department = models.ForeignKey(Major, on_delete=models.CASCADE, null=True, blank=True, related_name='courses')
```

#### 2. `courses/serializers.py`
```python
# 修改：移除专业必填验证，支持跨学院排课
def validate(self, attrs):
    if self.instance is None:
        name = attrs.get('name')
        course_type = attrs.get('course_type')
        teacher = attrs.get('teacher')
        # 专业改为可选
        if not name or not course_type or not teacher:
            raise serializers.ValidationError('课程名称、课程老师、必修/选修为必填')
```

#### 3. `courses/views.py`
**新增**：
- `OptimizeConflictsView`：自动优化冲突

**修改**：
- `AutoScheduleView`：支持20周智能排课，只排周一至周五
- `CourseScheduleViewSet.conflicts()`：增强冲突检测，返回更详细信息

#### 4. `courses/urls.py`
**新增路由**：
```python
path('schedules/optimize-conflicts', OptimizeConflictsView.as_view(), name='optimize_conflicts'),
```

### 前端文件

#### 1. `static/js/courses/courses.js`

**新增函数**：
- `editCourse(id)`：打开课程编辑模态框
- `loadEditTeacherOptions(searchQuery)`：加载教师选项（支持搜索）
- `loadEditTeacherColleges()`：加载学院选项
- `loadEditTeacherCollegeDepts(collegeId)`：加载专业选项（级联）
- `saveEditCourse()`：保存课程编辑
- `closeEditCourse()`：关闭编辑模态框
- `showConflictModal(conflicts, isSuccess)`：显示冲突检测模态框
- `closeConflictModal()`：关闭冲突模态框
- `optimizeConflicts()`：执行自动优化

**修改函数**：
- `loadCourses()`：更新显示格式为"课程名—老师"，添加编辑按钮
- `renderPalette()`：更新拖拽卡片显示格式
- `addCourse()`：专业改为可选
- `autoSchedule()`：支持20周智能排课
- `checkConflicts()`：使用模态框显示检测结果

#### 2. `templates/courses.html`

**新增模态框**：
- `editCourseModal`：课程编辑模态框
  - 课程名称输入
  - 课程类型选择
  - 教师搜索输入
  - 学院-专业级联筛选
  - 教师选择下拉框
  
- `conflictModal`：冲突检测结果模态框
  - 动态标题（成功/冲突数量）
  - 冲突详情列表
  - 自动优化按钮

## API 端点汇总

### 课程管理
- `GET /api/courses/courses/`：获取课程列表（支持搜索和筛选）
- `POST /api/courses/courses/`：新增课程
- `GET /api/courses/courses/{id}/`：获取课程详情
- `PATCH /api/courses/courses/{id}/`：编辑课程
- `DELETE /api/courses/courses/{id}/`：删除课程

### 课程表管理
- `GET /api/courses/schedules/`：获取课程表
- `POST /api/courses/schedules/`：添加课程安排
- `DELETE /api/courses/schedules/{id}/`：删除课程安排

### 智能功能
- `POST /api/courses/schedules/auto`：智能排课（20周，周一至周五）
- `GET /api/courses/schedules/conflicts/`：冲突检测
- `POST /api/courses/schedules/optimize-conflicts`：自动优化冲突

### 教师管理（用于课程编辑）
- `GET /api/accounts/teachers/`：获取教师列表（支持搜索和筛选）

## 使用说明

### 1. 搜索课程
- 在课程列表顶部输入框输入课程名或教师名
- 选择学院和专业进行筛选
- 系统自动实时搜索

### 2. 编辑课程
1. 在课程列表找到要编辑的课程
2. 点击课程旁的编辑按钮（笔形图标）
3. 在弹出的模态框中修改课程信息
4. 可以搜索教师或使用学院-专业筛选
5. 点击"保存"按钮提交修改

### 3. 新增课程
1. 填写课程名称
2. 选择必修/选修
3. 选择教师（可搜索或筛选）
4. 专业可选（留空表示跨学院课程）
5. 点击"新增"按钮

### 4. 智能排课
1. 在课程列表中勾选要排课的课程
2. 筛选选择班级
3. 点击"智能排课"按钮
4. 确认排课（20周，周一至周五）
5. 系统自动安排课程到最优时间段

### 5. 冲突检测
1. 选择班级查看课表
2. 点击"冲突检测"按钮
3. 系统弹出检测结果：
   - 无冲突：显示成功提示
   - 有冲突：显示冲突详情列表
4. 冲突课程在课表中标红显示

### 6. 自动优化
1. 冲突检测发现冲突后
2. 在冲突模态框中点击"自动优化"按钮
3. 系统自动调整冲突课程到可用时间段
4. 显示优化结果

## 技术特点

### 1. 用户体验
- **实时反馈**：搜索、筛选实时响应
- **模态框交互**：编辑和冲突检测使用模态框，不跳转页面
- **视觉提示**：冲突课程标红显示
- **详细信息**：冲突检测提供完整的冲突详情

### 2. 数据验证
- **前后端双重验证**：确保数据完整性
- **灵活性**：支持跨学院排课
- **冲突避免**：智能排课自动避免各类冲突

### 3. 智能算法
- **优先级策略**：必修课优先、上午优先、均匀分布
- **冲突检测**：多维度检测（教师、班级、教室）
- **自动优化**：智能调整冲突课程

### 4. 扩展性
- **模块化设计**：各功能独立，易于维护
- **API驱动**：前后端分离，便于扩展
- **配置化**：排课策略可通过配置调整

## 注意事项

### 1. 智能排课
- 排课前建议先清空或检查现有课表
- 20周排课可能需要较长时间，请耐心等待
- 如果课程数量很多，建议分批次排课

### 2. 冲突检测
- 检测范围包含所有周次
- 建议在排课后及时进行冲突检测
- 课表修改后应重新检测

### 3. 自动优化
- 只能优化班级课表的冲突
- 如果无可用时间段，部分课程可能无法优化
- 优化后建议再次检测确认

### 4. 跨学院排课
- 新增课程时专业可以留空
- 留空表示该课程可以跨学院、专业、班级使用
- 已有课程可以通过编辑移除专业限制

## 后续优化建议

1. **批量操作**：支持批量编辑课程
2. **排课模板**：保存常用的排课方案
3. **冲突预警**：添加课程时实时提示可能的冲突
4. **排课策略配置**：允许管理员自定义排课优先级
5. **导出功能**：导出冲突检测报告
6. **历史记录**：记录排课和优化历史

## 维护说明

### 前端维护
- 课程显示格式：修改 `loadCourses()` 和 `renderPalette()` 函数
- 编辑功能：修改 `editCourse()` 相关函数
- 智能排课：修改 `autoSchedule()` 函数
- 冲突检测：修改 `checkConflicts()` 和 `showConflictModal()` 函数

### 后端维护
- 排课算法：修改 `AutoScheduleView` 类
- 冲突检测：修改 `CourseScheduleViewSet.conflicts()` 方法
- 优化策略：修改 `OptimizeConflictsView` 类
- 验证规则：修改 `CourseSerializer.validate()` 方法

## 总结

本次更新全面提升了课程管理系统的功能性和用户体验：
- ✅ 课程显示更清晰（课程名—老师格式）
- ✅ 编辑功能更便捷（模态框+搜索筛选）
- ✅ 排课更智能（20周自动排课）
- ✅ 冲突检测更完善（详细信息+可视化）
- ✅ 自动优化功能（一键解决冲突）
- ✅ 跨学院排课支持（灵活性更强）

所有功能已完成开发和测试，可以投入使用！

