# 课程管理系统工作流程图

## 目录
1. [系统架构图](#系统架构图)
2. [数据库关系图](#数据库关系图)
3. [页面交互流程](#页面交互流程)
4. [API调用时序图](#api调用时序图)
5. [排课算法流程](#排课算法流程)

---

## 系统架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                          用户界面层                               │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │  课程管理页  │  │  课程表页面  │  │  搜索页面    │          │
│  │ courses.html │  │   (集成)     │  │ search.html  │          │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘          │
│         │                 │                  │                   │
└─────────┼─────────────────┼──────────────────┼───────────────────┘
          │                 │                  │
          └─────────────────┴──────────────────┘
                            │
┌───────────────────────────┼────────────────────────────────────┐
│                    前端逻辑层 (JavaScript)                       │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │              courses.js (主控制器)                        │  │
│  ├──────────────┬──────────────┬──────────────┬─────────────┤  │
│  │ 课程管理模块 │ 拖拽控制模块 │ 课程表渲染   │ 智能排课    │  │
│  │ - loadCourses│ - handleDrop │ - render     │ - auto      │  │
│  │ - addCourse  │ - dragStart  │ - loadSlots  │ - conflicts │  │
│  │ - updateCrs  │ - dragEnd    │ - viewSwitch │ - schedule  │  │
│  └──────┬───────┴──────┬───────┴──────┬───────┴──────┬──────┘  │
│         │              │              │              │          │
└─────────┼──────────────┼──────────────┼──────────────┼──────────┘
          │              │              │              │
          └──────────────┴──────────────┴──────────────┘
                            │
                    RESTful API (JSON)
                            │
┌───────────────────────────┼────────────────────────────────────┐
│                     Django 后端层                               │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │                    URLs 路由                              │  │
│  │  /api/courses/courses/       → CourseViewSet            │  │
│  │  /api/courses/schedules/     → CourseScheduleViewSet    │  │
│  │  /api/courses/auto-schedule/ → AutoScheduleView         │  │
│  │  /api/courses/timeslots/     → TimeSlotViewSet          │  │
│  └────────────────────┬─────────────────────────────────────┘  │
│                       │                                         │
│  ┌────────────────────┴─────────────────────────────────────┐  │
│  │                 ViewSets & Views                         │  │
│  ├──────────────┬──────────────┬──────────────┬────────────┤  │
│  │ CourseViewSet│ScheduleView  │ AutoSchedule │ TimeSlot   │  │
│  │ - list()     │ - list()     │ - post()     │ - list()   │  │
│  │ - create()   │ - create()   │ - algorithm  │ - generate │  │
│  │ - update()   │ - update()   │ - conflicts  │            │  │
│  │ - destroy()  │ - delete()   │              │            │  │
│  └──────┬───────┴──────┬───────┴──────┬───────┴──────┬─────┘  │
│         │              │              │              │         │
│  ┌──────┴──────────────┴──────────────┴──────────────┴─────┐  │
│  │                    Serializers                           │  │
│  │  - CourseSerializer (数据校验+序列化)                    │  │
│  │  - CourseScheduleSerializer (冲突检测+校验)              │  │
│  │  - TimeSlotSerializer                                    │  │
│  └──────┬───────────────────────────────────────────────────┘  │
│         │                                                       │
└─────────┼───────────────────────────────────────────────────────┘
          │
┌─────────┼───────────────────────────────────────────────────────┐
│         │              Django ORM                               │
│  ┌──────┴───────────────────────────────────────────────────┐  │
│  │                    Models                                 │  │
│  ├──────────────┬──────────────┬──────────────┬─────────────┤  │
│  │ Course       │ CourseSchedule│ TimeSlot    │ Classroom   │  │
│  │ - subject_id │ - school_class│ - weekday   │ - building  │  │
│  │ - name       │ - course      │ - start_time│ - capacity  │  │
│  │ - teacher    │ - teacher     │ - end_time  │             │  │
│  │ - department │ - classroom   │ - index     │             │  │
│  └──────┬───────┴──────┬───────┴──────┬───────┴──────┬──────┘  │
│         │              │              │              │          │
└─────────┼──────────────┼──────────────┼──────────────┼──────────┘
          │              │              │              │
┌─────────┴──────────────┴──────────────┴──────────────┴──────────┐
│                      数据库层 (SQLite/PostgreSQL)                │
│  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐       │
│  │ courses_course│  │courses_schedule│ │courses_timeslot│       │
│  └───────────────┘  └───────────────┘  └───────────────┘       │
└──────────────────────────────────────────────────────────────────┘
```

---

## 数据库关系图 (ER Diagram)

```
┌─────────────────────┐
│   Organization      │
│   (组织架构)        │
└──────────┬──────────┘
           │
     ┌─────┴─────┬─────────────┐
     │           │             │
┌────▼─────┐ ┌──▼────────┐ ┌──▼────────┐
│ College  │ │Department │ │   Class   │
│ (学院)   │ │  (专业)   │ │  (班级)   │
└──────────┘ └─────┬─────┘ └─────┬─────┘
                   │             │
                   │    ┌────────┘
                   │    │
                ┌──▼────▼─────┐
                │   Teacher    │◄───────────┐
                │   (教师)     │            │
                └──────────────┘            │
                                            │
┌────────────────┐                          │
│   Classroom    │                          │
│   (教室)       │                          │
│ - building     │                          │
│ - room_number  │                          │
│ - capacity     │                          │
└────────┬───────┘                          │
         │                                  │
         │                                  │
         │      ┌───────────────┐           │
         │      │    Course     │           │
         │      │    (课程)     │           │
         │      │ - subject_id  │           │
         │      │ - name        │───────────┘
         │      │ - course_type │ teacher_id (FK)
         │      └───────┬───────┘
         │              │
         │              │ course_id (FK)
         │              │
         │      ┌───────▼───────────────┐
         └──────►   CourseSchedule      │
                │   (课程表)            │
                │ - school_class_id (FK)│◄───┐
                │ - course_id (FK)      │    │
                │ - teacher_id (FK)     │    │
                │ - classroom_id (FK)   │    │
                │ - timeslot_id (FK)    │    │
                │ - week_number         │    │
                └───────┬───────────────┘    │
                        │                    │
                        │ timeslot_id (FK)   │
                        │                    │
                ┌───────▼────────┐           │
                │   TimeSlot     │           │
                │   (时间段)     │           │
                │ - weekday      │           │
                │ - start_time   │           │
                │ - end_time     │           │
                │ - index        │           │
                └────────────────┘           │
                                             │
                                    school_class_id (FK)


关系说明:
1. Course ─► Teacher (多对一): 一门课程由一位教师主讲
2. Course ─► Department (多对一): 一门课程属于一个专业
3. CourseSchedule ─► Course (多对一): 一条排课记录对应一门课程
4. CourseSchedule ─► Class (多对一): 一条排课记录对应一个班级
5. CourseSchedule ─► Teacher (多对一): 一条排课记录对应一位教师
6. CourseSchedule ─► Classroom (多对一): 一条排课记录对应一间教室
7. CourseSchedule ─► TimeSlot (多对一): 一条排课记录对应一个时间段
```

---

## 页面交互流程

### 1. 页面加载流程

```
用户访问 /courses
     │
     ▼
┌─────────────────┐
│ DOMContentLoaded│
└────────┬────────┘
         │
         ├──► loadColleges()      ──► GET /api/org/colleges
         │                            └─► 填充学院下拉框
         │
         ├──► loadDepartments()  ──► GET /api/org/departments
         │                            └─► 填充专业下拉框
         │
         ├──► loadTeachers()     ──► GET /api/accounts/teachers
         │                            └─► 填充教师下拉框
         │
         ├──► loadClasses()      ──► GET /api/org/classes
         │                            └─► 填充班级下拉框
         │
         ├──► loadRooms()        ──► GET /api/org/classrooms
         │                            └─► 填充教室下拉框
         │
         ├──► loadCourses()      ──► GET /api/courses/courses
         │                            └─► 显示课程列表
         │
         └──► initTimetable()    ──► GET /api/courses/timeslots
                                      └─► 渲染课程表网格
                                      └─► loadSchedule()
                                           └─► GET /api/courses/schedules?...
                                                └─► 显示已排课程
```

### 2. 课程搜索流程

```
用户输入关键词 "高等数学"
     │
     ▼
┌─────────────────┐
│ Input Event     │
│ (300ms debounce)│
└────────┬────────┘
         │
         ▼
   loadCourses()
         │
         ▼
  构造查询参数
  q = "高等数学"
  college = 1 (如果选中)
  department = 5 (如果选中)
         │
         ▼
  GET /api/courses/courses?q=高等数学&college=1&department=5
         │
         ▼
  ┌──────────────┐
  │ Django View  │
  │ 模糊查询:    │
  │ - 课程名     │
  │ - 教师姓名   │
  │ - 教师工号   │
  └──────┬───────┘
         │
         ▼
  返回匹配结果 JSON
  [{ id: 1, name: "高等数学", ... }]
         │
         ▼
  更新课程列表显示
  更新拖拽面板
```

### 3. 拖拽排课流程

```
Step 1: 用户从课程库拖拽"高等数学"
     │
     ▼
┌──────────────────┐
│ dragstart Event  │
│ 设置 dataTransfer│
│ { course: 1 }    │
└────────┬─────────┘
         │
         ▼
  添加 .is-dragging 类
  (使课程表格子高亮)
         │
         │
Step 2: 拖动到周一第2节的格子
         │
         ▼
┌──────────────────┐
│ dragover Event   │
│ 添加 .dragover 类│
└────────┬─────────┘
         │
         │
Step 3: 释放鼠标
         │
         ▼
┌──────────────────┐
│  drop Event      │
└────────┬─────────┘
         │
         ▼
  handleDrop(ev)
         │
         ├─► 解析数据: courseId = 1
         ├─► 获取格子信息: weekday=1, index=2
         ├─► 查找时间段: slotId = timeslot[1-2]
         │
         ▼
  构造排课数据
  {
    school_class: 1,     // 当前选中的班级
    course: 1,           // 拖拽的课程
    teacher: 5,          // 课程的教师
    classroom: null,     // 暂不指定
    timeslot: 2,         // 周一第2节
    week_number: 1       // 当前周次
  }
         │
         ▼
  POST /api/courses/schedules/
         │
         ▼
┌──────────────────────────┐
│ CourseScheduleSerializer │
│ .validate()              │
├──────────────────────────┤
│ ✓ 检查教师冲突           │
│ ✓ 检查班级冲突           │
│ ✓ 检查教室冲突           │
│ ✓ 检查教室容量           │
└────────┬─────────────────┘
         │
    ┌────┴────┐
    │         │
  失败       成功
    │         │
    │         ▼
    │    保存到数据库
    │    CourseSchedule.objects.create()
    │         │
    │         ▼
    │    返回 { id: 100, ... }
    │         │
    ▼         ▼
  显示错误  刷新课程表
  提示信息  loadSchedule()
            │
            ▼
         渲染新课程块
         在周一第2节显示"高等数学"
```

### 4. 智能排课流程

```
Step 1: 用户选择多门课程
     │
     ▼
  勾选课程复选框
  selectedCourses = [1, 2, 3, 4]
     │
     │
Step 2: 点击"智能排课"按钮
     │
     ▼
  autoSchedule()
     │
     ├─► 检查: 是否选择了班级?
     ├─► 检查: 是否选择了课程?
     │
     ▼
  构造请求数据
  {
    school_class: 1,
    courses: [1, 2, 3, 4],
    start_week: 1,
    end_week: 1,
    week_mode: "all"
  }
     │
     ▼
  POST /api/courses/auto-schedule/
     │
     ▼
┌────────────────────────────────────┐
│ AutoScheduleView.post()            │
└────────┬───────────────────────────┘
         │
         ▼
  加载所有时间段
  TimeSlot.objects.all()
  → [Slot1, Slot2, ..., Slot40]
         │
         ▼
  ┌─────────────────────────────┐
  │ 遍历: 每周 × 每课程          │
  │ for week in [1]:            │
  │   for course in [1,2,3,4]:  │
  └────────┬────────────────────┘
           │
           ▼
     ┌────────────────────────┐
     │ 遍历: 每个时间段       │
     │ for slot in all_slots: │
     └────────┬───────────────┘
              │
              ▼
        ┌──────────────────┐
        │ 冲突检测          │
        ├──────────────────┤
        │ 1. 班级冲突?     │
        │ CourseSchedule   │
        │ .filter(         │
        │   class=1,       │
        │   timeslot=slot, │
        │   week=1         │
        │ ).exists()       │
        │                  │
        │ 2. 教师冲突?     │
        │ 3. 教室冲突?     │
        └─────┬────────────┘
              │
         ┌────┴────┐
         │         │
       冲突      无冲突
         │         │
         │         ▼
         │    计算评分
         │    score = 0
         │    + 必修课且上午 +5
         │    + (10 - index) 优先早节次
         │         │
         │         ▼
         │    记录最高分时间段
         │    if score > best_score:
         │        best_slot = slot
         │         │
         └─────────┘
              │
              ▼
        找到最佳时间段?
              │
         ┌────┴────┐
         │         │
        是        否
         │         │
         │         ▼
         │    记录失败原因
         │    "无可用时间"
         │         │
         ▼         │
    创建排课       │
    CourseSchedule │
    .create()      │
         │         │
         └────┬────┘
              │
              ▼
        收集所有结果
        results = [
          { course: 1, schedule_id: 100 },
          { course: 2, schedule_id: 101 },
          { course: 3, schedule_id: null, reason: "班级冲突" },
          { course: 4, schedule_id: 102 }
        ]
              │
              ▼
        返回结果
        { created_count: 3, items: [...] }
              │
              ▼
        前端显示
        "智能排课完成: 成功3节"
              │
              ▼
        刷新课程表
        loadSchedule()
```

---

## API调用时序图

### 创建课程的时序图

```
用户         前端JS         Django View      Serializer      数据库
 │             │                │                │              │
 │ 填写表单    │                │                │              │
 │ [新增课程]  │                │                │              │
 │─────────────►                │                │              │
 │             │ addCourse()    │                │              │
 │             │                │                │              │
 │             │ POST /api/     │                │              │
 │             │ courses/courses│                │              │
 │             ├────────────────►                │              │
 │             │                │ create()       │              │
 │             │                │                │              │
 │             │                │ Serializer     │              │
 │             │                │ (payload)      │              │
 │             │                ├────────────────►              │
 │             │                │                │ validate()   │
 │             │                │                │ - 必填检查   │
 │             │                │                │ - 唯一性检查 │
 │             │                │                │              │
 │             │                │                │ save()       │
 │             │                │                ├──────────────►
 │             │                │                │     INSERT   │
 │             │                │                │     INTO     │
 │             │                │                │     courses  │
 │             │                │                │◄──────────────
 │             │                │                │   course_id  │
 │             │                │◄────────────────              │
 │             │                │  { id, name... }              │
 │             │◄────────────────                               │
 │             │  201 Created                                   │
 │             │  { id: 1, name: "高等数学" }                   │
 │             │                                                │
 │             │ loadCourses()                                  │
 │             ├────────────────►                               │
 │             │ GET /api/courses/courses                       │
 │             │                                                │
 │             │◄────────────────                               │
 │             │  [ {...}, {...} ]                              │
 │             │                                                │
 │◄─────────────                                                │
 │ 显示成功提示                                                 │
 │ 刷新课程列表                                                 │
```

### 拖拽排课的时序图

```
用户         前端JS         Django View      Serializer      数据库
 │             │                │                │              │
 │ 拖拽课程    │                │                │              │
 │ 到周一第2节 │                │                │              │
 │─────────────►                │                │              │
 │             │ handleDrop()   │                │              │
 │             │ createSchedule()│               │              │
 │             │                │                │              │
 │             │ POST /api/     │                │              │
 │             │ courses/       │                │              │
 │             │ schedules/     │                │              │
 │             ├────────────────►                │              │
 │             │  {             │                │              │
 │             │   school_class:1                │              │
 │             │   course: 1,   │                │              │
 │             │   timeslot: 2, │                │              │
 │             │   week: 1      │                │              │
 │             │  }             │                │              │
 │             │                │ create()       │              │
 │             │                ├────────────────►              │
 │             │                │                │ validate()   │
 │             │                │                │              │
 │             │                │                │ 1. 教师冲突? │
 │             │                │                │ SELECT *     │
 │             │                │                │ FROM schedules│
 │             │                │                │ WHERE teacher=5│
 │             │                │                │ AND timeslot=2│
 │             │                │                │◄──────────────
 │             │                │                │   0 rows     │
 │             │                │                │   ✓ 无冲突   │
 │             │                │                │              │
 │             │                │                │ 2. 班级冲突? │
 │             │                │                │ SELECT *     │
 │             │                │                │ WHERE class=1│
 │             │                │                │◄──────────────
 │             │                │                │   0 rows     │
 │             │                │                │   ✓ 无冲突   │
 │             │                │                │              │
 │             │                │                │ 3. 教室冲突? │
 │             │                │                │   (跳过)     │
 │             │                │                │              │
 │             │                │                │ save()       │
 │             │                │                ├──────────────►
 │             │                │                │   INSERT     │
 │             │                │                │◄──────────────
 │             │                │◄────────────────              │
 │             │◄────────────────                               │
 │             │  201 Created                                   │
 │             │  { id: 100 }                                   │
 │             │                                                │
 │             │ loadSchedule()                                 │
 │             ├────────────────►                               │
 │             │ GET /api/courses/schedules?class=1&week=1      │
 │             │                ├───────────────────────────────►
 │             │                │          SELECT *             │
 │             │                │          JOIN ...             │
 │             │                │◄───────────────────────────────
 │             │◄────────────────                               │
 │             │  [ {...} ]                                     │
 │◄─────────────                                                │
 │ 课程表更新                                                   │
 │ 显示"高等数学"在周一第2节                                    │
```

---

## 排课算法流程

### 智能排课算法详细流程

```
开始 autoSchedule()
│
├─ 输入参数
│  ├─ school_class: 1 (班级ID)
│  ├─ courses: [1, 2, 3, 4] (课程ID列表)
│  ├─ start_week: 1
│  ├─ end_week: 18
│  └─ week_mode: "all" (或 "odd" / "even")
│
├─ 计算周次列表
│  │  week_mode = "all"  → weeks = [1, 2, ..., 18]
│  │  week_mode = "odd"  → weeks = [1, 3, 5, ..., 17]
│  │  week_mode = "even" → weeks = [2, 4, 6, ..., 18]
│  └─ weeks = [1, 2, 3, ..., 18]
│
├─ 加载所有时间段
│  └─ slots = TimeSlot.objects.all().order_by('weekday', 'index')
│      → [
│          {id:1, weekday:1, index:1, start:"08:30"},
│          {id:2, weekday:1, index:2, start:"09:25"},
│          ...
│          {id:40, weekday:5, index:8, start:"17:00"}
│        ]
│
├─ 外层循环: 遍历周次
│  │
│  └─ for week in weeks:  # week = 1
│      │
│      └─ 内层循环: 遍历课程
│          │
│          └─ for course_id in courses:  # course_id = 1 (高等数学)
│              │
│              ├─ 加载课程信息
│              │  └─ course = Course.objects.get(id=1)
│              │      → {name: "高等数学", teacher: 5, ...}
│              │
│              ├─ 初始化变量
│              │  ├─ best_slot = None
│              │  ├─ best_score = -1
│              │  └─ conflict_flags = {
│              │       class: True,
│              │       teacher: True,
│              │       room: True
│              │     }
│              │
│              └─ 最内层循环: 遍历时间段
│                  │
│                  └─ for slot in slots:  # slot = {id:1, weekday:1, index:1}
│                      │
│                      ├─ 【冲突检测1】班级冲突
│                      │  │
│                      │  └─ query = CourseSchedule.objects.filter(
│                      │         school_class=1,
│                      │         timeslot=slot.id,
│                      │         week_number=1
│                      │     )
│                      │     │
│                      │     ├─ 如果 exists() == True
│                      │     │  └─ continue (跳过这个时间段)
│                      │     │
│                      │     └─ 如果 exists() == False
│                      │        └─ conflict_flags.class = False
│                      │           继续检测...
│                      │
│                      ├─ 【冲突检测2】教师冲突
│                      │  │
│                      │  └─ query = CourseSchedule.objects.filter(
│                      │         teacher=5,
│                      │         timeslot=slot.id,
│                      │         week_number=1
│                      │     )
│                      │     │
│                      │     ├─ 如果 exists() == True
│                      │     │  └─ continue
│                      │     │
│                      │     └─ 如果 exists() == False
│                      │        └─ conflict_flags.teacher = False
│                      │           继续检测...
│                      │
│                      ├─ 【冲突检测3】教室冲突 (如果指定了教室)
│                      │  └─ (逻辑同上)
│                      │
│                      ├─ 【评分机制】
│                      │  │
│                      │  ├─ 初始分数: score = 0
│                      │  │
│                      │  ├─ 规则1: 必修课优先安排上午
│                      │  │  │
│                      │  │  └─ if course.type == "required" 
│                      │  │        AND slot.index <= 4  # 上午4节
│                      │  │     then score += 5
│                      │  │
│                      │  ├─ 规则2: 优先选择早节次
│                      │  │  │
│                      │  │  └─ score += (10 - slot.index)
│                      │  │     # index=1 → +9分
│                      │  │     # index=2 → +8分
│                      │  │     # ...
│                      │  │     # index=8 → +2分
│                      │  │
│                      │  └─ 示例评分:
│                      │      - 必修课,周一第1节: score = 5 + 9 = 14分
│                      │      - 必修课,周一第2节: score = 5 + 8 = 13分
│                      │      - 选修课,下午第6节: score = 0 + 4 = 4分
│                      │
│                      └─ 【更新最佳时间段】
│                          │
│                          └─ if score > best_score:
│                                best_score = score
│                                best_slot = slot
│
├─ 找到最佳时间段后
│  │
│  ├─ 如果 best_slot != None:
│  │  │
│  │  ├─ 构造排课数据
│  │  │  └─ payload = {
│  │  │        school_class: 1,
│  │  │        course: 1,
│  │  │        teacher: 5,
│  │  │        classroom: None,
│  │  │        timeslot: best_slot.id,
│  │  │        week_number: 1
│  │  │     }
│  │  │
│  │  ├─ 创建排课记录
│  │  │  └─ schedule = CourseSchedule.objects.create(**payload)
│  │  │
│  │  └─ 记录结果
│  │     └─ results.append({
│  │           course: 1,
│  │           week: 1,
│  │           schedule_id: schedule.id,
│  │           reason: None
│  │        })
│  │
│  └─ 如果 best_slot == None:
│     │
│     ├─ 分析失败原因
│     │  │
│     │  ├─ 如果 所有冲突标志都为True
│     │  │  └─ reason = "全部冲突"
│     │  │
│     │  ├─ 如果 仅班级冲突为True
│     │  │  └─ reason = "班级冲突"
│     │  │
│     │  ├─ 如果 仅教师冲突为True
│     │  │  └─ reason = "教师冲突"
│     │  │
│     │  └─ 否则
│     │     └─ reason = "无可用时间"
│     │
│     └─ 记录失败
│        └─ results.append({
│              course: 1,
│              week: 1,
│              schedule_id: None,
│              reason: reason
│           })
│
├─ 返回结果
│  │
│  └─ return {
│        created_count: 72,  # 成功创建的数量
│        items: [
│          { course: 1, week: 1, schedule_id: 100, reason: None },
│          { course: 1, week: 2, schedule_id: 101, reason: None },
│          ...
│          { course: 2, week: 5, schedule_id: None, reason: "教师冲突" },
│          ...
│        ]
│     }
│
└─ 结束
```

### 评分示例表

| 课程类型 | 时间段 | 节次 | 规则1得分 | 规则2得分 | 总分 | 排名 |
|---------|--------|------|----------|----------|------|------|
| 必修 | 周一第1节 | 1 | +5 | +9 | 14 | ⭐⭐⭐⭐⭐ |
| 必修 | 周一第2节 | 2 | +5 | +8 | 13 | ⭐⭐⭐⭐⭐ |
| 必修 | 周一第4节 | 4 | +5 | +6 | 11 | ⭐⭐⭐⭐ |
| 必修 | 周一第5节 | 5 | +0 | +5 | 5 | ⭐⭐ |
| 选修 | 周一第1节 | 1 | +0 | +9 | 9 | ⭐⭐⭐⭐ |
| 选修 | 周一第6节 | 6 | +0 | +4 | 4 | ⭐⭐ |
| 选修 | 周一第8节 | 8 | +0 | +2 | 2 | ⭐ |

---

## 冲突检测流程

```
开始 checkConflicts()
│
├─ 输入参数
│  ├─ school_class: 1 (如果按班级查看)
│  ├─ teacher: 5 (如果按教师查看)
│  ├─ classroom: 10 (如果按教室查看)
│  └─ week_number: 1
│
├─ 加载排课数据
│  └─ schedules = CourseSchedule.objects.filter(
│        school_class=1,
│        week_number=1
│     )
│     → [
│         {id:100, timeslot:2, teacher:5, class:1, room:10},
│         {id:101, timeslot:2, teacher:5, class:1, room:15},
│         {id:102, timeslot:3, teacher:6, class:1, room:10},
│         ...
│       ]
│
├─ 按时间段分组
│  │
│  └─ data = {}
│     for schedule in schedules:
│         key = (schedule.timeslot, schedule.week_number)
│         data[key].append(schedule)
│     
│     结果:
│     data = {
│       (2, 1): [
│         {id:100, teacher:5, class:1, room:10},
│         {id:101, teacher:5, class:1, room:15}  # 同一时间段有2条记录!
│       ],
│       (3, 1): [
│         {id:102, teacher:6, class:1, room:10}
│       ],
│       ...
│     }
│
├─ 检测冲突
│  │
│  └─ conflicts = []
│     
│     for (timeslot, week), schedules in data.items():
│         │
│         ├─ 如果该时间段只有1条记录
│         │  └─ continue (无冲突)
│         │
│         └─ 如果该时间段有多条记录
│            │
│            ├─ 统计教师出现次数
│            │  │
│            │  └─ teachers = {}
│            │     for s in schedules:
│            │         teachers[s.teacher] = teachers.get(s.teacher, 0) + 1
│            │     
│            │     teachers = {
│            │       5: 2,  # 教师5在同一时间有2节课 → 冲突!
│            │       6: 1
│            │     }
│            │
│            ├─ 统计班级出现次数
│            │  │
│            │  └─ classes = {}
│            │     for s in schedules:
│            │         classes[s.school_class] += 1
│            │     
│            │     classes = {
│            │       1: 2  # 班级1在同一时间有2节课 → 冲突!
│            │     }
│            │
│            ├─ 统计教室出现次数
│            │  │
│            │  └─ rooms = {}
│            │     for s in schedules:
│            │         if s.classroom:
│            │             rooms[s.classroom] += 1
│            │     
│            │     rooms = {
│            │       10: 1,
│            │       15: 1
│            │     }  # 无冲突
│            │
│            └─ 记录冲突
│               └─ conflicts.append({
│                     timeslot: 2,
│                     week_number: 1,
│                     count: 2,
│                     schedule_ids: [100, 101],
│                     teacher_conflicts: [5],  # 冲突的教师ID
│                     class_conflicts: [1],    # 冲突的班级ID
│                     room_conflicts: []
│                  })
│
├─ 返回结果
│  │
│  └─ return {
│        count: 1,  # 总共有1个时间段存在冲突
│        items: conflicts
│     }
│
└─ 前端处理
   │
   ├─ 如果 count == 0
   │  └─ 显示: "未发现冲突" (绿色)
   │
   └─ 如果 count > 0
      │
      ├─ 显示: "发现 X 处冲突" (红色)
      │
      └─ 高亮冲突的课程块
         └─ for conflict in items:
               for schedule_id in conflict.schedule_ids:
                   block = document.querySelector(`[data-schedule-id="${schedule_id}"]`)
                   block.classList.add('conflict')  # 红色边框+动画
```

---

## 总结

### 核心流程图

```
┌─────────────┐
│  用户访问   │
└──────┬──────┘
       │
       ▼
┌─────────────────┐
│  加载页面数据   │
│ - 学院/专业     │
│ - 教师/班级     │
│ - 课程/时间段   │
└──────┬──────────┘
       │
       ├────────────────┬────────────────┐
       │                │                │
       ▼                ▼                ▼
┌──────────┐    ┌──────────┐    ┌──────────┐
│ 课程管理 │    │ 手动排课 │    │ 智能排课 │
│ - 搜索   │    │ - 拖拽   │    │ - 算法   │
│ - 新增   │    │ - 移动   │    │ - 批量   │
│ - 编辑   │    │ - 删除   │    │ - 检测   │
└──────┬───┘    └────┬─────┘    └────┬─────┘
       │             │               │
       └─────────────┴───────────────┘
                     │
                     ▼
              ┌─────────────┐
              │ 数据库存储  │
              │ CourseSchedule│
              └─────────────┘
```

### 数据流向

```
输入 → 校验 → 处理 → 存储 → 响应 → 显示

1. 输入: 用户操作 (拖拽/点击/输入)
2. 校验: 前端基础校验 + 后端深度校验
3. 处理: 业务逻辑 (算法/权限/计算)
4. 存储: 数据库持久化
5. 响应: API返回结果
6. 显示: 前端渲染更新
```

---

**文档版本**: 1.0  
**最后更新**: 2025-12-09

