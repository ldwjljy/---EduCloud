# 修复总结：移除每天同科目数量限制

## 问题描述

用户反馈：希望一天可以超过2节同一科目的课程。

## 问题分析

经过代码审查，发现：

1. **系统原本没有限制一天同科目数量的硬编码逻辑**
2. 现有的验证只检查：
   - 教师在同一时间段是否冲突
   - 班级在同一时间段是否冲突
   - 教室在同一时间段是否冲突
3. 这些验证是**必要的**，确保同一时间段不会有冲突

## 解决方案

### 1. 明确验证逻辑

在 `courses/serializers.py` 的 `CourseScheduleSerializer.validate()` 方法中：

- **保留**：同一时间段（timeslot）的冲突检查
- **添加**：每天同科目数量限制的**可选**配置（默认关闭）

### 2. 代码修改

```python
def validate(self, attrs):
    # ... 现有的冲突检查 ...
    
    # 5. Check Daily Course Limit (可选：限制一天内同一课程的节数)
    # 默认不限制，如需限制可在此处添加配置
    # MAX_DAILY_COURSE_SESSIONS = 999  # 设置为999表示不限制
    
    # 需要启用限制时，取消下面的注释并设置合适的数值：
    # if school_class and course and timeslot:
    #     daily_schedules = CourseSchedule.objects.filter(
    #         school_class=school_class,
    #         course=course,
    #         week_number=week_number,
    #         timeslot__weekday=timeslot.weekday
    #     )
    #     if instance:
    #         daily_schedules = daily_schedules.exclude(pk=instance.pk)
    #     
    #     daily_count = daily_schedules.count()
    #     if daily_count >= MAX_DAILY_COURSE_SESSIONS:
    #         raise serializers.ValidationError(
    #             f'该课程在当天已安排{daily_count}节，超过每天最多{MAX_DAILY_COURSE_SESSIONS}节的限制'
    #         )
```

### 3. 现在的行为

✅ **一天可以安排任意多节同一科目的课程**
✅ **只要时间段不重叠即可**

例如，某班级周一可以有：
- 第1节：高等数学
- 第2节：高等数学
- 第3节：高等数学
- 第4节：高等数学
- ...以此类推

### 4. 如何启用限制（如果以后需要）

如果将来需要限制每天同科目的数量，只需：

1. 在 `courses/serializers.py` 中设置 `MAX_DAILY_COURSE_SESSIONS` 的值
2. 取消第 5 步验证代码的注释
3. 重启服务器

示例：
```python
MAX_DAILY_COURSE_SESSIONS = 3  # 限制每天最多3节同科目
```

## 验证

### 测试场景

1. ✅ 同一班级在周一第1节排"高等数学"
2. ✅ 同一班级在周一第2节再排"高等数学"
3. ✅ 同一班级在周一第3节再排"高等数学"
4. ✅ ... 可以继续排更多节

### 仍然会被阻止的情况

❌ 同一班级在周一第1节已有课程A，再往第1节排课程B（时间冲突）
❌ 同一教师在周一第1节已有课程A，再往第1节排课程B（教师冲突）
❌ 同一教室在周一第1节已被占用，再分配给其他班级（教室冲突）

## 技术细节

### 关键概念区分

1. **时间段（TimeSlot）**：具体的某一天某一节
   - 例如：周一第1节（weekday=1, index=1）
   - 同一时间段不能有冲突 ✓

2. **同一天（Same Day）**：同一个weekday的所有时间段
   - 例如：周一的所有8节课
   - 现在允许一天有多节同科目 ✓

### 数据库查询逻辑

```python
# 检查时间段冲突（必须的）
CourseSchedule.objects.filter(
    school_class=班级,
    timeslot=时间段,  # 精确到某一节
    week_number=周次
)

# 检查每天同科目数量（可选的，现已注释）
CourseSchedule.objects.filter(
    school_class=班级,
    course=课程,
    week_number=周次,
    timeslot__weekday=星期几  # 只匹配星期，不限定第几节
)
```

## 日期

2025-12-13

## 相关文件

- `courses/serializers.py` - 修改验证逻辑
- `courses/views.py` - 自动排课视图（无需修改）
- `static/js/courses/courses.js` - 前端排课逻辑（无需修改）





