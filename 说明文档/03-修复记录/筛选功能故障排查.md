# 课程筛选功能故障排查指南

## 问题：筛选下拉框没有数据

### 🔍 原因分析

筛选功能需要从数据库查询以下数据：
1. **学院** (`College`) - `/api/org/colleges`
2. **专业** (`Major/Department`) - `/api/org/departments`
3. **班级** (`Class`) - `/api/org/classes`

如果看不到数据，可能的原因：
- ❌ 数据库中没有数据
- ❌ 用户权限不足
- ❌ API调用失败
- ❌ JavaScript错误

---

## 📋 诊断步骤

### 步骤1: 检查数据库数据

运行测试脚本：
```bash
python test_api_endpoints.py
```

或双击运行：
```
test_api.bat
```

**预期输出**：
```
======================================================================
测试数据库数据
======================================================================

【学院数量】: 2
  - 人工智能应用 (ID: 1, Code: 05)
  - 计算机科学 (ID: 2, Code: 02)

【专业数量】: 3
  - 移动互联网应用技术 (ID: 1, 学院: 人工智能应用)
  - 软件技术 (ID: 2, 学院: 计算机科学)
  ...

【班级数量】: 5
  - 2023年移动互联网应用技术G5-1班 (ID: 1, 专业: 移动互联网应用技术, 年级: 2023)
  ...

✓ 数据库数据正常！
```

**如果显示0条数据**：
→ 需要先创建学院、专业、班级数据
→ 参考：运行导入脚本或在系统中手动创建

---

### 步骤2: 检查浏览器控制台

1. 打开课程管理页面：`http://localhost:8000/courses`
2. 按 `F12` 打开开发者工具
3. 切换到 `Console` 标签
4. 查看日志输出

**正常情况应该看到**：
```
✓ 加载学院数据: 2 个
✓ 加载专业数据: 3 个
✓ 加载班级数据: 5 个
数据加载完成: {colleges: 2, departments: 3, classes: 5}
```

**如果看到错误**：
```
✗ 加载学院失败: Error: ...
```
→ 检查权限或API端点

---

### 步骤3: 检查API响应

在浏览器控制台（Console）运行：

```javascript
// 测试API是否能访问
fetch('/api/org/colleges', {
    headers: {
        'Authorization': 'Bearer ' + localStorage.getItem('token')
    }
})
.then(r => r.json())
.then(data => console.log('学院数据:', data))
.catch(e => console.error('错误:', e));
```

**预期结果**：
```javascript
学院数据: [
  {id: 1, name: "人工智能应用", code: "05", ...},
  {id: 2, name: "计算机科学", code: "02", ...}
]
```

**如果返回空数组 `[]`**：
→ 权限问题，见步骤4

**如果返回 401/403 错误**：
→ 未登录或权限不足

---

### 步骤4: 检查用户权限

#### 权限说明

organization/views.py 中的权限检查：

```python
# CollegeViewSet - 学院查询权限
permission_classes = [IsAuthenticated, CollegePermission]

# MajorViewSet - 专业查询权限
def get_queryset(self):
    # 超级管理员：查看所有
    if user.is_superuser:
        return queryset
    
    # 学院管理员：查看本学院
    if role in ['dean', 'vice_dean']:
        return queryset.filter(college=teacher.department.college)
    
    # 其他：无权限
    return queryset.none()
```

#### 解决方法

**方法1：使用超级管理员账号**
```bash
python manage.py createsuperuser
```
然后用超级管理员登录系统

**方法2：修改权限设置**
临时允许所有已登录用户查看数据（仅开发环境）：

编辑 `organization/views.py`：
```python
class CollegeViewSet(viewsets.ModelViewSet):
    queryset = College.objects.filter(is_deleted=False)
    permission_classes = [IsAuthenticated]  # 移除 CollegePermission
    # ...
```

---

### 步骤5: 检查网络请求

1. 打开开发者工具（F12）
2. 切换到 `Network` 标签
3. 刷新页面
4. 查找以下请求：
   - `/api/org/colleges`
   - `/api/org/departments`
   - `/api/org/classes`

**检查每个请求**：
- Status: 应该是 `200 OK`
- Response: 应该包含数据

**如果是 404**：
→ URL路由配置错误

**如果是 500**：
→ 服务器错误，检查Django日志

---

## 🔧 常见问题解决

### 问题1: 数据库中没有数据

**症状**：
```
【学院数量】: 0
【专业数量】: 0
【班级数量】: 0
```

**解决**：
需要创建基础数据。可以：

#### 方法A: 使用Django Admin
1. 访问 `http://localhost:8000/admin`
2. 登录管理员账号
3. 创建学院、专业、班级

#### 方法B: 使用Django Shell
```bash
python manage.py shell
```

```python
from organization.models import College, Major, Class

# 创建学院
college = College.objects.create(
    code='05',
    name='人工智能应用',
    status='active'
)

# 创建专业
major = Major.objects.create(
    code='01',
    name='移动互联网应用技术',
    college=college,
    duration_type='5_year'
)

# 创建班级
Class.objects.create(
    major=major,
    enrollment_year=2023,
    class_number=1
)

print("✓ 数据创建成功！")
```

#### 方法C: 使用导入脚本
如果有导入脚本，运行：
```bash
python import_organization_data.py
```

---

### 问题2: 权限不足

**症状**：
- API返回空数组 `[]`
- 或返回 403 Forbidden

**解决**：

#### 临时解决（开发环境）：
编辑 `organization/views.py`，简化权限检查：

```python
class MajorViewSet(viewsets.ModelViewSet):
    def get_queryset(self):
        queryset = super().get_queryset()
        
        # 临时允许所有已登录用户查看
        if self.request.user.is_authenticated:
            return queryset
        
        return queryset.none()
```

#### 永久解决：
确保用户有正确的角色和权限设置。

---

### 问题3: JavaScript错误

**症状**：
控制台显示 JavaScript 错误

**解决**：
1. 清除浏览器缓存（Ctrl + Shift + Delete）
2. 强制刷新页面（Ctrl + F5）
3. 检查 `courses.js` 是否正确加载

---

### 问题4: CORS 错误

**症状**：
```
Access to fetch at '...' from origin '...' has been blocked by CORS policy
```

**解决**：
编辑 `EduCloud/settings.py`，确保CORS配置正确：

```python
INSTALLED_APPS = [
    ...
    'corsheaders',
    ...
]

MIDDLEWARE = [
    'corsheaders.middleware.CorsMiddleware',
    ...
]

CORS_ALLOW_ALL_ORIGINS = True  # 开发环境
```

---

## ✅ 验证修复

修复后，重新测试：

### 1. 运行数据测试
```bash
python test_api_endpoints.py
```
应该显示数据数量 > 0

### 2. 打开课程页面
```
http://localhost:8000/courses
```

### 3. 检查筛选状态
页面应该显示：
```
✓ 数据加载成功！找到 X 个学院，请选择学院开始筛选
```

### 4. 测试筛选功能
- 点击"学院"下拉框 → 应该看到学院列表
- 选择学院 → 应该看到专业列表
- 选择专业 → 应该看到年级列表
- 选择年级 → 应该看到班级列表
- 选择班级 → 应该看到课程表

---

## 🆘 仍然无法解决？

### 收集诊断信息

运行以下命令并将输出发送给技术支持：

```bash
# 1. 测试数据
python test_api_endpoints.py > diagnosis.txt

# 2. Django版本
python manage.py --version >> diagnosis.txt

# 3. 已安装的包
pip list >> diagnosis.txt
```

### 检查Django日志

在运行 `python manage.py runserver` 的终端窗口中查看错误信息。

### 浏览器控制台日志

1. 打开开发者工具（F12）
2. Console标签中的所有错误信息
3. Network标签中失败的API请求详情

---

## 📞 快速诊断清单

- [ ] 运行 `test_api.bat` 确认数据库有数据
- [ ] 确认用户已登录
- [ ] 确认用户是超级管理员或有查看权限
- [ ] 打开浏览器控制台检查JavaScript错误
- [ ] 检查Network标签确认API请求成功
- [ ] 清除浏览器缓存并刷新
- [ ] 重启Django服务器

---

**文档版本**: 1.0  
**更新日期**: 2025-12-09

