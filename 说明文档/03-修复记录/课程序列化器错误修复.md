# 额外修复：课程序列化器字段错误

## 问题描述

在修复四级级联筛选后，发现课程列表加载时出现500错误：

```
FieldError: Unsupported lookup 'department_id' for ForeignKey or join on the field not permitted.
```

## 错误位置

`courses/serializers.py` 第24行：

```python
return StudentProfile.objects.filter(school_class__department_id=obj.department_id).count()
```

## 问题原因

### 数据模型关系

- `Course` 模型有 `department` 字段（ForeignKey → Major）
- `StudentProfile` 模型有 `school_class` 字段（ForeignKey → Class）
- `Class` 模型有 `major` 字段（ForeignKey → Major）
- **注意**：`Class` 模型的字段名是 `major`，不是 `department`

### 错误原因

代码错误地使用了 `school_class__department_id`，但实际上应该是：
- `school_class__major` 来访问班级的专业

## 解决方案

修改 `courses/serializers.py` 第21-24行：

```python
# 修改前（错误）
def get_student_count(self, obj):
    if not obj.department_id:
        return 0
    return StudentProfile.objects.filter(school_class__department_id=obj.department_id).count()

# 修改后（正确）
def get_student_count(self, obj):
    if not obj.department_id:
        return 0
    return StudentProfile.objects.filter(school_class__major=obj.department).count()
```

## 修改说明

1. **字段名修正**：`school_class__department_id` → `school_class__major`
2. **使用对象引用**：`obj.department_id` → `obj.department`（直接使用外键对象，Django会自动处理）

## 影响范围

这个修复解决了：
- ✅ 课程列表加载失败的问题
- ✅ 课程管理页面500错误
- ✅ 课程序列化时的字段错误

## 验证方法

### 1. 检查服务器日志

重启服务器后，访问课程管理页面，服务器日志不应再出现：
```
FieldError: Unsupported lookup 'department_id' for ForeignKey
```

### 2. 浏览器测试

访问课程管理页面：
```
http://localhost:8000/courses/
```

应该能看到：
- ✅ 课程列表正常加载
- ✅ 四级筛选器正常显示和工作
- ✅ 课程拖拽面板显示课程列表
- ✅ 没有控制台错误

### 3. API测试

访问课程API：
```
http://localhost:8000/api/courses/courses/
```

应该返回：
- 状态码：200
- 响应格式：包含课程列表的JSON数据
- 每个课程包含 `student_count` 字段

## 数据模型关系图

```
Course (课程)
  └─ department (ForeignKey) → Major (专业)

StudentProfile (学生档案)
  └─ school_class (ForeignKey) → Class (班级)
                                   └─ major (ForeignKey) → Major (专业)
```

## 正确的查询路径

要从课程获取学生数量：

```python
# Course → Major
course.department  

# StudentProfile → Class → Major
StudentProfile.objects.filter(school_class__major=course.department)
```

## 完成状态

- [x] 问题定位
- [x] 代码修复
- [x] Linter检查通过
- [x] 文档更新

## 注意事项

修复后需要：
1. **重启Django服务器**
2. **刷新浏览器**（Ctrl+F5强制刷新）
3. 测试课程列表是否正常加载

---

修复日期：2025年12月9日
相关问题：四级级联筛选功能修复

