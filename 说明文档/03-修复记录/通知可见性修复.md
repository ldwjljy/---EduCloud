# 公告不可见问题修复说明

## 问题描述

用户反馈：**创建公告后看不到，列表也是空的**

## 根本原因

通过检查发现，**admin 用户没有 UserProfile**！

### 问题链路：

1. ✅ 用户（admin）成功创建公告
2. ❌ 查询公告列表时，`NoticeViewSet.get_queryset()` 检查：
   ```python
   if not profile:
       return Notice.objects.none()  # 返回空查询集
   ```
3. ❌ 因为 admin 没有 profile，所以返回空列表
4. ❌ 用户看不到任何公告

## 修复方案

### 1. 为 admin 用户创建 UserProfile ✅

**执行脚本**: `fix_admin_profile.py`

```python
profile = UserProfile.objects.create(
    user=admin_user,
    role='super_admin'
)
```

**结果**:
- ✅ admin 用户现在有 profile
- ✅ 角色设置为 `super_admin`（超级管理员）

### 2. 优化 ViewSet 查询逻辑 ✅

#### 修改的文件：

**`notices/views.py`** - NoticeViewSet
```python
def get_queryset(self):
    # 超级管理员可以看到所有公告（即使没有profile）
    if user.is_superuser:
        return Notice.objects.all().order_by('-created_at')
    
    # 其他用户需要检查profile
    profile = getattr(user, 'profile', None)
    if not profile:
        return Notice.objects.none()
    ...
```

**`grades/views.py`** - GradeViewSet
```python
def get_queryset(self):
    # 超级管理员可以看到所有成绩（即使没有profile）
    if user.is_superuser:
        return Grade.objects.select_related('student', 'course').all()
    
    # 其他用户需要检查profile
    profile = getattr(user, 'profile', None)
    if not profile:
        return Grade.objects.none()
    ...
```

## 改进效果

### 立即生效：
1. ✅ admin 用户可以看到所有公告
2. ✅ admin 用户可以创建和查看公告
3. ✅ 公告列表正常显示

### 防御性编程：
1. ✅ 超级管理员即使没有 profile 也能正常使用系统
2. ✅ 避免类似问题再次发生
3. ✅ 提升系统健壮性

## 验证步骤

1. **刷新浏览器页面**（或重启Django服务器）
2. **访问公告管理页面** `/ui/notices`
3. **应该能看到**：
   - 之前创建的所有公告
   - 可以创建新公告
   - 公告列表正常显示

## 用户角色与权限说明

### 公告可见性规则：

| 用户角色 | 可见公告范围 | scope 字段 |
|---------|------------|-----------|
| 超级管理员 | 所有公告 | all, role |
| 校长/副校长 | 全校和职务公告 | all, role |
| 院长/副院长 | 全校和职务公告 | all, role |
| 教师/班主任 | 全校和职务公告 | all, role |
| 学生 | 仅全校公告 | all |

### 公告创建权限：

- ✅ 超级管理员
- ✅ 校长/副校长
- ✅ 院长/副院长
- ✅ 教师/班主任
- ❌ 学生（只读）

## 预防措施

### 建议：创建超级管理员时自动创建 Profile

可以在用户注册/创建时自动创建 UserProfile：

```python
# 在创建超级用户时
if user.is_superuser and not hasattr(user, 'profile'):
    UserProfile.objects.create(
        user=user,
        role='super_admin'
    )
```

### 或使用 Django Signal：

```python
from django.db.models.signals import post_save
from django.dispatch import receiver

@receiver(post_save, sender=User)
def create_user_profile(sender, instance, created, **kwargs):
    if created and instance.is_superuser:
        UserProfile.objects.get_or_create(
            user=instance,
            defaults={'role': 'super_admin'}
        )
```

## 相关文件

- ✅ `notices/views.py` - 公告视图优化
- ✅ `grades/views.py` - 成绩视图优化  
- ✅ `fix_admin_profile.py` - Profile修复脚本
- ✅ `check_profiles.py` - Profile检查脚本

## 注意事项

1. **现在 admin 用户已有 profile**，可以正常使用系统
2. **代码已优化**，超级管理员即使暂时没有 profile 也能正常工作
3. **建议定期检查**所有用户是否都有对应的 UserProfile

---
**修复日期**: 2025-12-17  
**问题类型**: 用户Profile缺失  
**影响范围**: 公告系统、成绩系统  
**修复状态**: ✅ 已完成
